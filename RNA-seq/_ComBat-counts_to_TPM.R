library(DESeq2)
directory <- '/mnt/mone/Project/WC300/02.RNA-seq/07.Kallisto_GencodeV24_Trimmed/ALL_abundance'
fileName<- c("14002_N.tsv", "14006_N.tsv", "14007_N.tsv", "14009_N.tsv", "14020_N.tsv", "14021_N.tsv", "15001_N.tsv", "15002_N.tsv", "15005_N.tsv", "15006_N.tsv", "16002_N.tsv", "16010_N.tsv", "16015_N.tsv", "16018_N.tsv", "16021_N.tsv", "16022_N.tsv", "16025_N.tsv", "16031_N.tsv", "17014_N.tsv", "17017_N.tsv", "17024_N.tsv", "17027_N.tsv", "17032_N.tsv", "17039_N.tsv", "17040_N.tsv", "17041_N.tsv", "17043_N.tsv", "17044_N.tsv", "17049_N.tsv", "18001_N.tsv", "18002_N.tsv", "18003_N.tsv", "18004_N.tsv", "18005_N.tsv", "18006_N.tsv", "18007_N.tsv", "18008_N.tsv", "18009_N.tsv", "18010_N.tsv", "18011_N.tsv", "18013_N.tsv", "18014_N.tsv", "18015_N.tsv", "18016_N.tsv", "18017_N.tsv", "19001_N.tsv", "19004_N.tsv", "19005_N.tsv", "19006_N.tsv", "19007_N.tsv", "19008_N.tsv", "19010_N.tsv", "19014_N.tsv", "19021_N.tsv", "19025_N.tsv", "19028_N.tsv", "19032_N.tsv", "19033_N.tsv", "19035_N.tsv", "19036_N.tsv", "19038_N.tsv", "19040_N.tsv", "19041_N.tsv", "19055_N.tsv", "19081_N.tsv", "19082_N.tsv", "20001_N.tsv", "20002_N.tsv", "20004_N.tsv", "20018_N.tsv", "20037_N.tsv", "20054_N.tsv", "20068_N.tsv", "20080_N.tsv", "20082_N.tsv", "20084_N.tsv", "20087_N.tsv", "20089_N.tsv", "20092_N.tsv", "20094_N.tsv", "20095_N.tsv", "20102_N.tsv", "20114_N.tsv", "20115_N.tsv", "14002_T.tsv", "14006_T.tsv", "14007_T.tsv", "14009_T.tsv", "14020_T.tsv", "14021_T.tsv", "15001_T.tsv", "15002_T.tsv", "15005_T.tsv", "15006_T.tsv", "16002_T.tsv", "16010_T.tsv", "16015_T.tsv", "16018_T.tsv", "16021_T.tsv", "16022_T.tsv", "16025_T.tsv", "16031_T.tsv", "17014_T.tsv", "17017_T.tsv", "17024_T.tsv", "17027_T.tsv", "17032_T.tsv", "17039_T.tsv", "17040_T.tsv", "17041_T.tsv", "17043_T.tsv", "17044_T.tsv", "17049_T.tsv", "18001_T.tsv", "18002_T.tsv", "18003_T.tsv", "18004_T.tsv", "18005_T.tsv", "18006_T.tsv", "18007_T.tsv", "18008_T.tsv", "18009_T.tsv", "18010_T.tsv", "18011_T.tsv", "18013_T.tsv", "18014_T.tsv", "18015_T.tsv", "18016_T.tsv", "18017_T.tsv", "19001_T.tsv", "19004_T.tsv", "19005_T.tsv", "19006_T.tsv", "19007_T.tsv", "19008_T.tsv", "19010_T.tsv", "19014_T.tsv", "19021_T.tsv", "19025_T.tsv", "19028_T.tsv", "19032_T.tsv", "19033_T.tsv", "19035_T.tsv", "19036_T.tsv", "19038_T.tsv", "19040_T.tsv", "19041_T.tsv", "19055_T.tsv", "19081_T.tsv", "19082_T.tsv", "20001_T.tsv", "20002_T.tsv", "20004_T.tsv", "20018_T.tsv", "20037_T.tsv", "20054_T.tsv", "20068_T.tsv", "20080_T.tsv", "20082_T.tsv", "20084_T.tsv", "20087_T.tsv", "20089_T.tsv", "20092_T.tsv", "20094_T.tsv", "20095_T.tsv", "20102_T.tsv", "20114_T.tsv", "20115_T.tsv")
sampleName <- c("14002_N", "14006_N", "14007_N", "14009_N", "14020_N", "14021_N", "15001_N", "15002_N", "15005_N", "15006_N", "16002_N", "16010_N", "16015_N", "16018_N", "16021_N", "16022_N", "16025_N", "16031_N", "17014_N", "17017_N", "17024_N", "17027_N", "17032_N", "17039_N", "17040_N", "17041_N", "17043_N", "17044_N", "17049_N", "18001_N", "18002_N", "18003_N", "18004_N", "18005_N", "18006_N", "18007_N", "18008_N", "18009_N", "18010_N", "18011_N", "18013_N", "18014_N", "18015_N", "18016_N", "18017_N", "19001_N", "19004_N", "19005_N", "19006_N", "19007_N", "19008_N", "19010_N", "19014_N", "19021_N", "19025_N", "19028_N", "19032_N", "19033_N", "19035_N", "19036_N", "19038_N", "19040_N", "19041_N", "19055_N", "19081_N", "19082_N", "20001_N", "20002_N", "20004_N", "20018_N", "20037_N", "20054_N", "20068_N", "20080_N", "20082_N", "20084_N", "20087_N", "20089_N", "20092_N", "20094_N", "20095_N", "20102_N", "20114_N", "20115_N", "14002_T", "14006_T", "14007_T", "14009_T", "14020_T", "14021_T", "15001_T", "15002_T", "15005_T", "15006_T", "16002_T", "16010_T", "16015_T", "16018_T", "16021_T", "16022_T", "16025_T", "16031_T", "17014_T", "17017_T", "17024_T", "17027_T", "17032_T", "17039_T", "17040_T", "17041_T", "17043_T", "17044_T", "17049_T", "18001_T", "18002_T", "18003_T", "18004_T", "18005_T", "18006_T", "18007_T", "18008_T", "18009_T", "18010_T", "18011_T", "18013_T", "18014_T", "18015_T", "18016_T", "18017_T", "19001_T", "19004_T", "19005_T", "19006_T", "19007_T", "19008_T", "19010_T", "19014_T", "19021_T", "19025_T", "19028_T", "19032_T", "19033_T", "19035_T", "19036_T", "19038_T", "19040_T", "19041_T", "19055_T", "19081_T", "19082_T", "20001_T", "20002_T", "20004_T", "20018_T", "20037_T", "20054_T", "20068_T", "20080_T", "20082_T", "20084_T", "20087_T", "20089_T", "20092_T", "20094_T", "20095_T", "20102_T", "20114_T", "20115_T")
Condition <- c("Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Normal", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor", "Tumor")
samplePatient <- c("14002", "14006", "14007", "14009", "14020", "14021", "15001", "15002", "15005", "15006", "16002", "16010", "16015", "16018", "16021", "16022", "16025", "16031", "17014", "17017", "17024", "17027", "17032", "17039", "17040", "17041", "17043", "17044", "17049", "18001", "18002", "18003", "18004", "18005", "18006", "18007", "18008", "18009", "18010", "18011", "18013", "18014", "18015", "18016", "18017", "19001", "19004", "19005", "19006", "19007", "19008", "19010", "19014", "19021", "19025", "19028", "19032", "19033", "19035", "19036", "19038", "19040", "19041", "19055", "19081", "19082", "20001", "20002", "20004", "20018", "20037", "20054", "20068", "20080", "20082", "20084", "20087", "20089", "20092", "20094", "20102", "20095", "20114", "20115", "14002", "14006", "14007", "14009", "14020", "14021", "15001", "15002", "15005", "15006", "16002", "16010", "16015", "16018", "16021", "16022", "16025", "16031", "17014", "17017", "17024", "17027", "17032", "17039", "17040", "17041", "17043", "17044", "17049", "18001", "18002", "18003", "18004", "18005", "18006", "18007", "18008", "18009", "18010", "18011", "18013", "18014", "18015", "18016", "18017", "19001", "19004", "19005", "19006", "19007", "19008", "19010", "19014", "19021", "19025", "19028", "19032", "19033", "19035", "19036", "19038", "19040", "19041", "19055", "19081", "19082", "20001", "20002", "20004", "20018", "20037", "20054", "20068", "20080", "20082", "20084", "20087", "20089", "20092", "20094", "20095", "20102", "20114", "20115")
batch <- c("HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00136505", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00138322", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00136505", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00136505", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00136505", "HN00136505", "HN00136505", "HN00136505", "HN00134008 ", "HN00134008 ", "HN00136505", "HN00134008 ", "HN00134008 ", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00141729", "HN00139597", "HN00142894", "HN00142894", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00136505", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00135539", "HN00138322", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00121358", "HN00136505", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00136505", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00134008 ", "HN00136505", "HN00136505", "HN00136505", "HN00136505", "HN00134008 ", "HN00134008 ", "HN00136505", "HN00134008 ", "HN00134008 ", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00139597", "HN00142894", "HN00142894", "HN00141729")

sampleTable <- data.frame(sample=sampleName, 
                          file=fileName, 
                          condition=as.factor(Condition), 
                          patient=as.factor(samplePatient), 
                          batch=batch)
files <- file.path(directory, sampleTable$file)
names(files) <- paste0(sampleName)

library(tximport)

txi <- tximport(files, type="kallisto", txOut=TRUE)

library(sva)

adjusted_counts <- ComBat_seq(count=txi$counts, batch=sampleTable$batch, group=sampleTable$condition)
txi$counts <- adjusted_counts

tpm <- function(counts, lengths) {
  rate <- counts / lengths
  rate / sum(rate) * 1e6
}


